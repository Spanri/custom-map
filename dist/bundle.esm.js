let t=0,e=0,i=0,o=0,s=!1;function l(t,e){s=!1}function n(t,e,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e[t]=i}function h(h,r){n("mousedown",h,(l=>function(l,n){l||(l=window.event),l.target&&"IMG"===l.target.nodeName?l.preventDefault():l.srcElement&&"IMG"===l.srcElement.nodeName&&(l.returnValue=!1),i=l.clientX+n.scrollLeft,o=l.clientY+n.scrollTop,t=0,e=0,s=!0}(l,h))),n("mousemove",h,(l=>function(l,n,h){s&&(l||(l=window.event),t=i-(l.clientX+n.scrollLeft),e=o-(l.clientY+n.scrollTop),n.scrollLeft+=t,n.scrollTop+=e,h())}(l,h,r))),n("mouseup",h,(t=>l())),n("mouseup",window,(t=>l()))}function r(t){const e=t.el.getElementsByClassName("cm-plugin")[0],i=e.getElementsByClassName("cm-zoom-in")[0],o=e.getElementsByClassName("cm-zoom-out")[0];t.zoom<=t.minZoom?(i.removeAttribute("disabled"),o.setAttribute("disabled","")):t.zoom>=t.maxZoom?(i.setAttribute("disabled",""),o.removeAttribute("disabled")):(i.removeAttribute("disabled"),o.setAttribute("disabled",""))}var a={hooks:{afterInit:t=>{const e=t.el.getElementsByClassName("cm-plugin")[0];e.appendChild('\n        <div class="cm-zoom">\n          <button class="cm-zoom-in">-</button>\n          <button class="cm-zoom-out">+</button>\n        </div>\n      ');e.getElementsByClassName("cm-zoom-in")[0].addEventListener("click",(()=>{t.setZoom(t.zoom+1)}));e.getElementsByClassName("cm-zoom-out")[0].addEventListener("click",(()=>{t.setZoom(t.zoom-1)})),r(t)},afterZoom:t=>{console.log("after zoom"),r(t)}}},m={Core:class{constructor(t,{center:e,zoom:i,minZoom:o,maxZoom:s,tileUrl:l,xCount:n,yCount:r,minZoomTileSize:a,hooks:m,plugins:c}){this._ctx=null,this._tileUrl=null,this._el=t,this._zoom=i||0,this._minZoom=o||0,this._maxZoom=s||5,this._tileUrl=l||null,this._minZoomTileSize=a||200,this._xCount=n||2,this._yCount=r||2,this._center=e||[this._xCount/2,this._yCount/2],this._hooks=m||{};const d=document.createElement("CANVAS");d.width=400,d.height=400,d.classList.add("cm-canvas"),this._el.appendChild(d),this._ctx=d.getContext("2d");const u=document.createElement("div");u.classList.add("cm-plugin"),this._el.appendChild(u),this.setPlugins(c),h(this._el,this.drawTiles),m&&m.afterInit&&m.afterInit(this)}load(){this.handleCenter(),this.drawTiles()}drawTiles(){if(this._ctx.clearRect(0,0,this._minZoomTileSize*this._xCount,this._minZoomTileSize*this._yCount),this._tileUrl){console.log({visibleTiles:this.visibleTiles});for(let t=this.visibleTiles.yMin;t<=this.visibleTiles.yMax;t++)for(let e=this.visibleTiles.xMin;e<=this.visibleTiles.xMax;e++){console.log("x="+e+" y="+t);const i=new Image;i.onload=()=>{this._ctx.drawImage(i,this.currentTileSize*e,this.currentTileSize*t,this.currentTileSize-3,this.currentTileSize-3),this._ctx.fill()},i.src=this._tileUrl(this._zoom,t,e)}}}handleCenter(){this._el.scrollLeft=this._center[0]*this.currentTileSize-this.elRect.width/2,this._el.scrollTop=this._center[1]*this.currentTileSize-this.elRect.width/2}get elRect(){const t=this._el.getBoundingClientRect(),e=getComputedStyle(this._el),i=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),o=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom),s=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth),l=parseFloat(e.borderTopWidth)+parseFloat(e.borderBottomWidth);return{...t,width:this._el.offsetWidth-i-s,height:this._el.offsetHeight-o-l}}get currentTileSize(){return 0==this._minZoom?this._minZoomTileSize/((this._zoom+1)/(this._minZoom+1)):this._minZoomTileSize/(this._zoom/this._minZoom)}get visibleTiles(){return{xMin:Math.floor(this._el.scrollLeft/this.currentTileSize),xMax:Math.floor((this._el.scrollLeft+this.elRect.width-1)/this.currentTileSize),yMin:Math.floor(this._el.scrollTop/this.currentTileSize),yMax:Math.floor((this._el.scrollTop+this.elRect.height-1)/this.currentTileSize)}}setHooks(t){this._hooks=t}setPlugins(t){t&&t.length&&(t.forEach((t=>{Object.entries(t).forEach((([t,e])=>{this[t]=e}))})),console.log(this))}setTileUrl(t){this._tileUrl=t}setCenter([t,e]){this._center=[t,e],this._hooks&&this._hooks.afterCenter&&this._hooks.afterCenter(this)}setZoom(t){this._zoom=t,this.drawTiles(),this._hooks&&this._hooks.afterZoom&&this._hooks.afterZoom(this)}},zoomPlugin:a};export default m;
